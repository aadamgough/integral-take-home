// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
}

// User roles: PATIENT can submit enrollment applications, REVIEWER can screen them
enum Role {
  PATIENT
  REVIEWER
}

// Clinical trial enrollment application status workflow
enum IntakeStatus {
  PENDING // Application submitted, awaiting review
  IN_REVIEW // Coordinator is screening the application
  APPROVED // Application approved for enrollment
  REJECTED // Application rejected or ineligible
}

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  password     String
  name         String
  role         Role
  organization String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  submittedIntakes Intake[]   @relation("SubmittedBy")
  reviewedIntakes  Intake[]   @relation("ReviewedBy")
  auditLogs        AuditLog[]
}

model Intake {
  id        String       @id @default(cuid())
  status    IntakeStatus @default(PENDING)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  // Patient information (PII fields should be redacted in initial screening)
  clientName  String // Full name of patient applicant
  clientEmail String // Contact email
  clientPhone String // Phone number - PII, should be redacted in initial view
  dateOfBirth String // Date of birth - PII, should be redacted in initial view
  ssn         String // Social Security Number - PII, should be redacted in initial view

  // Application details
  description String // Reason for enrollment, medical history, etc.
  notes       String? // Additional notes from patient or reviewer

  // Relations
  submittedById String
  submittedBy   User       @relation("SubmittedBy", fields: [submittedById], references: [id])
  reviewerId    String?
  reviewer      User?      @relation("ReviewedBy", fields: [reviewerId], references: [id])
  auditLogs     AuditLog[]
  documents     Document[] // Supporting documents uploaded by patient
}

model AuditLog {
  id        String   @id @default(cuid())
  action    String // e.g., "CREATED", "STATUS_CHANGED", "VIEWED", "ASSIGNED", "DOCUMENT_UPLOADED"
  details   String? // JSON string with additional details
  createdAt DateTime @default(now())

  // Relations
  userId   String
  user     User   @relation(fields: [userId], references: [id])
  intakeId String
  intake   Intake @relation(fields: [intakeId], references: [id])
}

// Supporting documents uploaded by patients (medical records, insurance cards, etc.)
model Document {
  id          String   @id @default(cuid())
  fileName    String // Original file name
  fileType    String // MIME type (e.g., "application/pdf", "image/jpeg")
  fileSize    Int // File size in bytes
  filePath    String // Storage path or URL
  description String? // Optional description of the document
  createdAt   DateTime @default(now())

  // Relations
  intakeId String
  intake   Intake @relation(fields: [intakeId], references: [id], onDelete: Cascade)
}
